pipeline {
    agent any

    tools {
        nodejs "node16" // NodeJS installed in Jenkins Global Tools
    }

    environment {
        DIST_DIR = "dist"
        IIS_DEPLOY = "C:\\inetpub\\wwwroot\\admin"
        APP_POOL = "admin" // Change if your App Pool name is different
    }

    triggers {
        pollSCM('* * * * *') // Poll Git every minute (or use GitHub webhook)
    }

    stages {
        stage('Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/merlinpratheesh/jenkinsAdmin.git'
            }
        }

        stage('Install Dependencies') {
            steps {
                bat 'npm install'
            }
        }

        stage('Build App') {
            steps {
                bat 'npx nx build admin --configuration=production'
            }
        }

        stage('Prepare IIS Deployment') {
            steps {
                powershell """
                Write-Host 'Stopping App Pool...'
                Stop-WebAppPool -Name '$env:APP_POOL'

                Write-Host 'Cleaning IIS folder...'
                if (Test-Path '$env:IIS_DEPLOY') {
                    Remove-Item '$env:IIS_DEPLOY\\*' -Recurse -Force
                } else {
                    New-Item -Path '$env:IIS_DEPLOY' -ItemType Directory
                }
                """
            }
        }

        stage('Deploy to IIS') {
            steps {
                powershell """
                Write-Host 'Deploying files...'
                robocopy '$env:DIST_DIR\\admin' '$env:IIS_DEPLOY' /MIR /MT:8

                Write-Host 'Restarting App Pool...'
                Start-WebAppPool -Name '$env:APP_POOL'
                """
            }
        }
    }

    post {
        success {
            echo "✅ Build & Deploy Successful! Visit your IIS URL."
        }
        failure {
            echo "❌ Build Failed. Check Jenkins logs."
        }
    }
}
